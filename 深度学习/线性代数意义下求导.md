# 线性代数导数法则：普适性定义与公式体系
本体系完全基于**函数映射类型**和**维度规则**构建，无具体示例，仅包含通用定义、公式及底层逻辑，可直接套用至任意符合映射类型的函数。


## 一、基础符号与导数形态的普适定义
核心逻辑：**函数的“输入→输出”映射类型，唯一决定其导数的形态（维度/结构）**。所有符号定义均遵循“偏导数总数=输出自由度×输入自由度”的原则。

| 定义对象       | 函数映射类型                | 导数符号       | 导数形态（通用维度） | 维度推导逻辑                                                                 | 核心作用                                                                 |
|----------------|-----------------------------|----------------|----------------------|------------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 标量函数导数   | $f: \mathbb{R}^n \to \mathbb{R}$（n维向量输入→标量输出） | $\nabla f$（梯度） | $n \times 1$ 列向量   | 输入有$n$个自由度（$x_1,x_2,...,x_n$），输出1个自由度，偏导数共$n \times 1$个，按输入顺序排成列向量。 | 描述输入各分量对 scalar 输出的“影响强度与方向”。                          |
| 向量函数导数   | $g: \mathbb{R}^n \to \mathbb{R}^m$（n维向量输入→m维向量输出） | $J_g$（雅可比矩阵） | $m \times n$ 矩阵     | 输入$n$个自由度，输出$m$个自由度（$g_1,g_2,...,g_m$），偏导数共$m \times n$个，按“输出分量为行、输入分量为列”排列。 | 描述输入各分量对向量输出**每个分量**的“影响强度矩阵”。                    |
| 矩阵函数导数   | $A: \mathbb{R}^n \to \mathbb{R}^{p \times q}$（n维向量输入→p×q矩阵输出） | $T_A$（导数张量） | $p \times q \times n$ 三维张量 | 输入$n$个自由度，输出$p \times q$个自由度（矩阵元素$A_{11},A_{12},...,A_{pq}$），偏导数共$p \times q \times n$个，按“矩阵行→矩阵列→输入分量”构建三维结构。 | 描述输入各分量对矩阵输出**每个元素**的“影响强度张量”。                    |
| 迹运算         | 适用于任意方阵$M \in \mathbb{R}^{k \times k}$ | $\text{Tr}(M)$   | 标量                 | 方阵主对角线元素之和，即$\text{Tr}(M) = \sum_{i=1}^k M_{ii}$，无维度，仅作用于降维。 | 将多维导数（矩阵/张量）结果压缩为标量，适配梯度（n×1）的维度需求。        |
| 转置运算       | 适用于任意矩阵$M \in \mathbb{R}^{a \times b}$ | $M^\top$        | $b \times a$ 矩阵     | 交换矩阵的行与列，即$(M^\top)_{ij} = M_{ji}$。                              | 调整矩阵维度，使后续乘法满足“前矩阵列数=后矩阵行数”的规则。                |


## 二、链式法则（复合函数求导）的普适公式
链式法则的普适性本质：**复合函数的导数 = 各层函数导数的“维度兼容型复合”**，复合方式（矩阵乘法/转置/迹）由各层函数的映射类型决定。

### 2.1 场景1：向量→向量→标量（映射链：$f \circ g: \mathbb{R}^n \to \mathbb{R}$）
- **映射类型链**：输入$\mathbb{R}^n \xrightarrow{g} \mathbb{R}^m \xrightarrow{f} \mathbb{R}$，即内层函数$g$是$\mathbb{R}^n \to \mathbb{R}^m$（向量输出），外层函数$h$是$\mathbb{R}^m \to \mathbb{R}$（标量输出）。
- **普适公式**：$\nabla (f \circ g)(x) = J_g(x)^\top \cdot \nabla f(g(x))$
- **各符号定义**：
  - $\nabla (f \circ g)(x)$：复合函数对输入$x$的梯度，维度$n \times 1$，需与输入$\mathbb{R}^n$匹配。
  - $J_g(x)^\top$：内层函数$g$的雅可比矩阵的转置，原$J_g(x)$维度$m \times n$，转置后维度$n \times m$。
  - $\nabla f(g(x))$：外层函数$f$对$g(x)$的梯度，维度$m \times 1$，需与$g$的输出$\mathbb{R}^m$匹配。
- **维度匹配验证**：$n \times m$（转置雅可比）$\cdot m \times 1$（外层梯度）$= n \times 1$（复合梯度），满足维度兼容。
- **普适性核心逻辑**：因外层梯度是$m \times 1$（列向量），内层雅可比是$m \times n$，直接相乘维度不兼容，需转置雅可比为$n \times m$，确保乘法合法。

### 2.2 场景2：向量→向量→向量（映射链：$h \circ g: \mathbb{R}^n \to \mathbb{R}^p$）
- **映射类型链**：输入$\mathbb{R}^n \xrightarrow{g} \mathbb{R}^m \xrightarrow{h} \mathbb{R}^p$，即内层$g$是$\mathbb{R}^n \to \mathbb{R}^m$，外层$h$是$\mathbb{R}^m \to \mathbb{R}^p$，均为向量输出。
- **普适公式**：$J_{h \circ g}(x) = J_h(g(x)) \cdot J_g(x)$
- **各符号定义**：
  - $J_{h \circ g}(x)$：复合函数对$x$的雅可比矩阵，维度$p \times n$，需与“外层输出$\mathbb{R}^p$×输入$\mathbb{R}^n$”匹配。
  - $J_h(g(x))$：外层函数$h$对$g(x)$的雅可比矩阵，维度$p \times m$，需与“外层输出$\mathbb{R}^p$×内层输出$\mathbb{R}^m$”匹配。
  - $J_g(x)$：内层函数$g$对$x$的雅可比矩阵，维度$m \times n$，需与“内层输出$\mathbb{R}^m$×输入$\mathbb{R}^n$”匹配。
- **维度匹配验证**：$p \times m$（外层雅可比）$\cdot m \times n$（内层雅可比）$= p \times n$（复合雅可比），天然满足维度兼容，无需转置。
- **普适性核心逻辑**：向量函数的雅可比矩阵维度天然满足“前层输出维度=后层输入维度”，直接相乘即可传递“输入对最终输出的影响”。

### 2.3 场景3：向量→矩阵→标量（映射链：$f \circ A: \mathbb{R}^n \to \mathbb{R}$）
- **映射类型链**：输入$\mathbb{R}^n \xrightarrow{A} \mathbb{R}^{p \times q} \xrightarrow{f} \mathbb{R}$，即内层$A$是$\mathbb{R}^n \to \mathbb{R}^{p \times q}$（矩阵输出），外层$f$是$\mathbb{R}^{p \times q} \to \mathbb{R}$（标量输出）。
- **普适公式**：$\nabla (f \circ A)(x) = \text{Tr}\left( \nabla_A f(A(x)) \otimes T_A(x) \right)$
  （注：$\otimes$表示张量与矩阵的“适配乘法”，即$\nabla_A f$（$p \times q$矩阵）与$T_A(x)$（$p \times q \times n$张量）的每个“$p \times q$切片”相乘）
- **各符号定义**：
  - $\nabla (f \circ A)(x)$：复合函数对$x$的梯度，维度$n \times 1$，需与输入$\mathbb{R}^n$匹配。
  - $\nabla_A f(A(x))$：外层函数$f$对$A(x)$的导数（矩阵对 scalar 的导数），维度$p \times q$，需与$A$的输出$\mathbb{R}^{p \times q}$匹配。
  - $T_A(x)$：内层函数$A$对$x$的导数张量，维度$p \times q \times n$，需与“$A$的输出$\mathbb{R}^{p \times q}$×输入$\mathbb{R}^n$”匹配。
  - $\text{Tr}(\cdot)$：对“$\nabla_A f \otimes T_A(x)$”的结果（$n$个$p \times q$矩阵）分别求迹，得到$n$个标量，排成$n \times 1$梯度。
- **维度匹配验证**：$p \times q$（矩阵）$\otimes p \times q \times n$（张量）$= n$个$p \times q$矩阵，分别求迹后得到$n$个标量，构成$n \times 1$梯度，满足维度兼容。
- **普适性核心逻辑**：矩阵输出的导数是张量，需通过“矩阵-张量适配乘法”关联外层导数，再用迹降维至梯度维度。


## 三、乘积法则（乘积函数求导）的普适公式
乘积法则的普适性本质：**$(u \cdot v)' = u' \cdot v + u \cdot v'$**，其中$u'$、$v'$需替换为与$u$、$v$映射类型匹配的导数形态，且两项需满足“维度完全一致”。

### 3.1 场景1：向量点积（乘积映射：$f = u \cdot v: \mathbb{R}^n \to \mathbb{R}$）
- **乘积因子映射类型**：$u: \mathbb{R}^n \to \mathbb{R}^m$，$v: \mathbb{R}^n \to \mathbb{R}^m$（均为$\mathbb{R}^n \to \mathbb{R}^m$向量输出），点积后输出为标量（$\mathbb{R}$）。
- **普适公式**：$\nabla f(x) = J_u(x)^\top \cdot v(x) + J_v(x)^\top \cdot u(x)$
- **各符号定义与维度**：
  - $\nabla f(x)$：点积函数对$x$的梯度，维度$n \times 1$（标量输出对应梯度）。
  - $J_u(x)^\top \cdot v(x)$：第一项，$J_u(x)^\top$（$n \times m$，雅可比转置）$\cdot v(x)$（$m \times 1$，向量）$= n \times 1$。
  - $J_v(x)^\top \cdot u(x)$：第二项，$J_v(x)^\top$（$n \times m$，雅可比转置）$\cdot u(x)$（$m \times 1$，向量）$= n \times 1$。
- **维度匹配验证**：两项均为$n \times 1$，可直接相加，结果与$\nabla f(x)$维度一致。
- **普适性关键说明**：因向量点积输出为标量，需将向量函数的雅可比转置，与另一向量相乘得到梯度，确保两项维度统一。

### 3.2 场景2：矩阵乘法（乘积映射：$f = A \cdot B: \mathbb{R}^n \to \mathbb{R}^{p \times r}$）
- **乘积因子映射类型**：$A: \mathbb{R}^n \to \mathbb{R}^{p \times q}$（矩阵输出），$B: \mathbb{R}^n \to \mathbb{R}^{q \times r}$（矩阵输出），矩阵乘法后输出为$\mathbb{R}^{p \times r}$矩阵。
- **普适公式**：$T_f(x) = T_A(x) \cdot B(x) + A(x) \cdot T_B(x)$
  （注：$\cdot$表示“张量-矩阵适配乘法”，即$T_A(x)$（$p \times q \times n$张量）的每个“$p \times q$切片”与$B(x)$（$q \times r$矩阵）相乘，$A(x)$与$T_B(x)$的每个“$q \times r$切片”相乘）
- **各符号定义与维度**：
  - $T_f(x)$：矩阵乘积函数对$x$的导数张量，维度$p \times r \times n$（矩阵输出对应张量）。
  - $T_A(x) \cdot B(x)$：第一项，$p \times q \times n$（张量）$\cdot q \times r$（矩阵）$= p \times r \times n$（张量）。
  - $A(x) \cdot T_B(x)$：第二项，$p \times q$（矩阵）$\cdot q \times r \times n$（张量）$= p \times r \times n$（张量）。
- **维度匹配验证**：两项均为$p \times r \times n$，可直接相加，结果与$T_f(x)$维度一致。
- **普适性关键说明**：矩阵乘积的导数需通过“张量-矩阵适配乘法”，确保每个切片的乘法符合矩阵乘法规则（$p \times q \cdot q \times r = p \times r$），最终得到统一维度的张量。

### 3.3 场景3：标量-向量乘积（乘积映射：$f = s \cdot v: \mathbb{R}^n \to \mathbb{R}^m$）
- **乘积因子映射类型**：$s: \mathbb{R}^n \to \mathbb{R}$（标量输出），$v: \mathbb{R}^n \to \mathbb{R}^m$（向量输出），乘积后输出为$\mathbb{R}^m$向量。
- **普适公式**：$J_f(x) = s(x) \cdot J_v(x) + v(x) \cdot \nabla s(x)^\top$
- **各符号定义与维度**：
  - $J_f(x)$：标量-向量乘积函数对$x$的雅可比矩阵，维度$m \times n$（向量输出对应雅可比）。
  - $s(x) \cdot J_v(x)$：第一项，$s(x)$（标量）$\cdot J_v(x)$（$m \times n$，雅可比）$= m \times n$（矩阵）。
  - $v(x) \cdot \nabla s(x)^\top$：第二项，$v(x)$（$m \times 1$，向量）$\cdot \nabla s(x)^\top$（$1 \times n$，梯度转置）$= m \times n$（矩阵，向量外积）。
- **维度匹配验证**：两项均为$m \times n$，可直接相加，结果与$J_f(x)$维度一致。
- **普适性关键说明**：标量的导数是梯度（$n \times 1$），需转置为$1 \times n$，与向量$v(x)$做外积，才能得到与雅可比一致的$m \times n$维度。

### 3.4 场景4：标量-矩阵乘积（乘积映射：$f = s \cdot A: \mathbb{R}^n \to \mathbb{R}^{p \times q}$）
- **乘积因子映射类型**：$s: \mathbb{R}^n \to \mathbb{R}$（标量输出），$A: \mathbb{R}^n \to \mathbb{R}^{p \times q}$（矩阵输出），乘积后输出为$\mathbb{R}^{p \times q}$矩阵。
- **普适公式**：$T_f(x) = s(x) \cdot T_A(x) + A(x) \cdot \nabla s(x) \otimes I_{p \times q}$
  （注：$\otimes I_{p \times q}$表示“梯度与单位矩阵的张量积”，即$\nabla s(x)$（$n \times 1$）扩展为$p \times q \times n$张量，确保与$A(x)$相乘后维度匹配）
- **各符号定义与维度**：
  - $T_f(x)$：标量-矩阵乘积函数对$x$的导数张量，维度$p \times q \times n$（矩阵输出对应张量）。
  - $s(x) \cdot T_A(x)$：第一项，$s(x)$（标量）$\cdot T_A(x)$（$p \times q \times n$，张量）$= p \times q \times n$（张量）。
  - $A(x) \cdot \nabla s(x) \otimes I_{p \times q}$：第二项，$p \times q$（矩阵）$\cdot p \times q \times n$（扩展张量）$= p \times q \times n$（张量）。
- **维度匹配验证**：两项均为$p \times q \times n$，可直接相加，结果与$T_f(x)$维度一致。
- **普适性关键说明**：标量的梯度（$n \times 1$）需通过“与单位矩阵的张量积”扩展为矩阵输出对应的张量维度，才能与矩阵$A(x)$相乘。


## 四、普适性核心规则总结（所有场景通用）
1. **映射类型决定导数形态**：输入→输出的维度链（如$\mathbb{R}^n \to \mathbb{R}^m \to \mathbb{R}$）是选择导数符号（梯度/雅可比/张量）的唯一依据，无需依赖具体函数。
2. **维度兼容是运算前提**：
   - 矩阵乘法：必须满足“前矩阵列数=后矩阵行数”，不满足则转置其中一个（优先转置雅可比）。
   - 张量运算：必须满足“切片维度与矩阵维度匹配”，不满足则通过张量扩展（如与单位矩阵张量积）调整。
3. **法则本质不变，形式适配结构**：
   - 链式法则始终是“各层导数的复合”，复合方式由各层导数形态决定（矩阵乘/转置/迹）。
   - 乘积法则始终是“逐项求导+叠加”，导数形态由因子的映射类型决定，叠加前需确保两项维度完全一致。
