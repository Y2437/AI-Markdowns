# 一.基本函数求导法则
## 一、输入为向量（$\boldsymbol{x \in \mathbb{R}^n}$）的函数求导
输入向量$\boldsymbol{x} = [x_1, x_2, ..., x_n]^\top$（$n$个分量，$n$维自由度），按输出类型分为标量、向量、矩阵三类。


### 1.1 输出为标量（映射：$\mathbb{R}^n \to \mathbb{R}$）：求梯度$\nabla f$
#### 映射类型定义
函数$f: \mathbb{R}^n \to \mathbb{R}$，输入为$n$维向量$\boldsymbol{x}$，输出为单个实数（如损失函数、范数平方），核心是“$n$个输入变量决定1个输出值”。

#### 导数定义与符号
- **导数名称**：梯度（Gradient）  
- **符号**：$\nabla f(\boldsymbol{x})$ 或 $\nabla_{\boldsymbol{x}} f$  
- **维度**：$n \times 1$ 列向量（与输入向量维度一致，对应每个输入分量的偏导）  
- **数学本质**：函数$f$对输入$\boldsymbol{x}$的所有一阶偏导数构成的有序列向量。

#### 普适求导公式
$$\nabla f(\boldsymbol{x}) = \begin{bmatrix} \frac{\partial f}{\partial x_1} \\ \frac{\partial f}{\partial x_2} \\ \vdots \\ \frac{\partial f}{\partial x_n} \end{bmatrix}$$  
其中$\frac{\partial f}{\partial x_i}$表示函数$f$对输入向量$\boldsymbol{x}$的第$i$个分量$x_i$的一阶偏导数（$i=1,2,...,n$）。

#### 非基础名词解释
- **梯度的方向属性**：梯度$\nabla f(\boldsymbol{x})$的方向是函数$f$在点$\boldsymbol{x}$处**函数值增长最快的方向**，其模长$||\nabla f(\boldsymbol{x})||$等于该方向上的方向导数大小（即单位向量沿梯度方向时，函数值的变化率）。  
- **梯度与极值的关系**：若函数$f$在点$\boldsymbol{x}^*$处可微且取极值，则$\nabla f(\boldsymbol{x}^*) = \boldsymbol{0}_{n \times 1}$（零向量），此时$\boldsymbol{x}^*$称为“临界点”，需结合Hessian矩阵进一步判断极值类型。


### 1.2 输出为向量（映射：$\mathbb{R}^n \to \mathbb{R}^m$）：求雅可比矩阵$J_f$
#### 映射类型定义
函数$\boldsymbol{f}: \mathbb{R}^n \to \mathbb{R}^m$，输入为$n$维向量$\boldsymbol{x}$，输出为$m$维向量$\boldsymbol{f}(\boldsymbol{x}) = [f_1(\boldsymbol{x}), f_2(\boldsymbol{x}), ..., f_m(\boldsymbol{x})]^\top$（如特征映射、坐标变换），核心是“$n$个输入变量决定$m$个输出变量”。

#### 导数定义与符号
- **导数名称**：雅可比矩阵（Jacobian Matrix）  
- **符号**：$J_{\boldsymbol{f}}(\boldsymbol{x})$ 或 $J_f$  
- **维度**：$m \times n$ 矩阵（输出向量维度×输入向量维度，对应“输出分量×输入分量”的偏导）  
- **数学本质**：向量函数$\boldsymbol{f}$的每个输出分量对输入向量$\boldsymbol{x}$的所有分量的一阶偏导数构成的矩形矩阵。

#### 普适求导公式
$$J_{\boldsymbol{f}}(\boldsymbol{x}) = \begin{bmatrix} \frac{\partial f_1}{\partial x_1} & \frac{\partial f_1}{\partial x_2} & \cdots & \frac{\partial f_1}{\partial x_n} \\ \frac{\partial f_2}{\partial x_1} & \frac{\partial f_2}{\partial x_2} & \cdots & \frac{\partial f_2}{\partial x_n} \\ \vdots & \vdots & \ddots & \vdots \\ \frac{\partial f_m}{\partial x_1} & \frac{\partial f_m}{\partial x_2} & \cdots & \frac{\partial f_m}{\partial x_n} \end{bmatrix}$$  
其中$\frac{\partial f_j}{\partial x_i}$表示输出向量的第$j$个分量$f_j$对输入向量的第$i$个分量$x_i$的一阶偏导数（$j=1,2,...,m$；$i=1,2,...,n$）。

#### 非基础名词解释
- **雅可比的线性近似意义**：雅可比矩阵$J_{\boldsymbol{f}}(\boldsymbol{x})$是向量函数$\boldsymbol{f}$在点$\boldsymbol{x}$处的**局部线性近似矩阵**，即对邻近点$\boldsymbol{x}+\Delta\boldsymbol{x}$，有$\boldsymbol{f}(\boldsymbol{x}+\Delta\boldsymbol{x}) \approx \boldsymbol{f}(\boldsymbol{x}) + J_{\boldsymbol{f}}(\boldsymbol{x}) \cdot \Delta\boldsymbol{x}$（$\Delta\boldsymbol{x}$为微小扰动向量）。  
- **雅可比的秩与可逆性**：若$m=n$（输入输出维度相同）且$J_{\boldsymbol{f}}(\boldsymbol{x})$的秩为$n$（满秩），则$\boldsymbol{f}$在点$\boldsymbol{x}$处**局部可逆**（逆函数定理），其逆函数的雅可比矩阵为$J_{\boldsymbol{f}}(\boldsymbol{x})^{-1}$（原雅可比的逆矩阵）。


### 1.3 输出为矩阵（映射：$\mathbb{R}^n \to \mathbb{R}^{p \times q}$）：求导数张量$T_f$
#### 映射类型定义
函数$F: \mathbb{R}^n \to \mathbb{R}^{p \times q}$，输入为$n$维向量$\boldsymbol{x}$，输出为$p$行$q$列矩阵$F(\boldsymbol{x}) = [F_{kl}(\boldsymbol{x})]_{p \times q}$（如随参数变化的权重矩阵、变换矩阵），核心是“$n$个输入变量决定$p \times q$个输出元素”。

#### 导数定义与符号
- **导数名称**：导数张量（Derivative Tensor）  
- **符号**：$T_F(\boldsymbol{x})$ 或 $T_{F,\boldsymbol{x}}$  
- **维度**：$p \times q \times n$ 三维张量（输出矩阵维度+输入向量维度，对应“输出矩阵元素×输入向量分量”的偏导）  
- **数学本质**：矩阵函数$F$的每个元素对输入向量$\boldsymbol{x}$的所有分量的一阶偏导数构成的高阶有序结构，可理解为“$n$个$p \times q$矩阵切片的集合”。

#### 普适求导公式
$$T_F(\boldsymbol{x}) = \left[ \frac{\partial F_{kl}}{\partial x_i} \right]_{p \times q \times n}$$  
其“切片表示”更直观：对每个输入分量$x_i$（$i=1,2,...,n$），对应张量的第$i$个“$p \times q$切片”$T_F^{(i)}(\boldsymbol{x})$，满足：  
$$T_F^{(i)}(\boldsymbol{x}) = \begin{bmatrix} \frac{\partial F_{11}}{\partial x_i} & \frac{\partial F_{12}}{\partial x_i} & \cdots & \frac{\partial F_{1q}}{\partial x_i} \\ \frac{\partial F_{21}}{\partial x_i} & \frac{\partial F_{22}}{\partial x_i} & \cdots & \frac{\partial F_{2q}}{\partial x_i} \\ \vdots & \vdots & \ddots & \vdots \\ \frac{\partial F_{p1}}{\partial x_i} & \frac{\partial F_{p2}}{\partial x_i} & \cdots & \frac{\partial F_{pq}}{\partial x_i} \end{bmatrix}$$  
其中$F_{kl}$表示输出矩阵$F$的第$k$行第$l$列元素（$k=1,2,...,p$；$l=1,2,...,q$）。

#### 非基础名词解释
- **张量的切片意义**：三维张量$T_F$的第$i$个切片$T_F^{(i)}$，本质是“固定输入分量$x_i$时，输出矩阵$F$随$x_i$的变化率矩阵”——切片中每个元素$\frac{\partial F_{kl}}{\partial x_i}$，描述$x_i$微小变化对$F_{kl}$的影响强度。  
- **张量与向量的收缩运算**：若需计算“输入向量扰动$\Delta\boldsymbol{x}$对输出矩阵的影响”，可通过张量与向量的收缩运算实现：$\Delta F \approx \sum_{i=1}^n T_F^{(i)} \cdot \Delta x_i$（即每个切片乘以对应扰动分量后求和），结果为$p \times q$矩阵，与输出矩阵维度一致。


## 二、输入为矩阵（$\boldsymbol{X \in \mathbb{R}^{p \times q}}$）的函数求导
输入矩阵$\boldsymbol{X} = [X_{kl}]_{p \times q}$（$p \times q$个元素，$pq$维自由度），按输出类型分为标量、矩阵两类（输出为向量的场景较少见，且可转化为矩阵→矩阵的特例，故不单独列出）。


### 2.1 输出为标量（映射：$\mathbb{R}^{p \times q} \to \mathbb{R}$）：求矩阵导数$\nabla_X f$
#### 映射类型定义
函数$f: \mathbb{R}^{p \times q} \to \mathbb{R}$，输入为$p \times q$矩阵$\boldsymbol{X}$，输出为单个实数（如矩阵的迹、行列式、范数），核心是“$p \times q$个输入元素决定1个输出值”。

#### 导数定义与符号
- **导数名称**：矩阵导数（Matrix Derivative）  
- **符号**：$\nabla_{\boldsymbol{X}} f$ 或 $\frac{\partial f}{\partial \boldsymbol{X}}$  
- **维度**：$p \times q$ 矩阵（与输入矩阵维度完全一致，对应“输入矩阵元素×输出标量”的偏导）  
- **数学本质**：函数$f$对输入矩阵$\boldsymbol{X}$的所有一阶偏导数构成的有序矩阵，其结构与输入矩阵完全对齐。

#### 普适求导公式
$$\nabla_{\boldsymbol{X}} f = \begin{bmatrix} \frac{\partial f}{\partial X_{11}} & \frac{\partial f}{\partial X_{12}} & \cdots & \frac{\partial f}{\partial X_{1q}} \\ \frac{\partial f}{\partial X_{21}} & \frac{\partial f}{\partial X_{22}} & \cdots & \frac{\partial f}{\partial X_{2q}} \\ \vdots & \vdots & \ddots & \vdots \\ \frac{\partial f}{\partial X_{p1}} & \frac{\partial f}{\partial X_{p2}} & \cdots & \frac{\partial f}{\partial X_{pq}} \end{bmatrix}$$  
其中$\frac{\partial f}{\partial X_{kl}}$表示函数$f$对输入矩阵$\boldsymbol{X}$的第$k$行第$l$列元素$X_{kl}$的一阶偏导数（$k=1,2,...,p$；$l=1,2,...,q$）。

#### 非基础名词解释
- **矩阵导数与迹的关联**：对多数矩阵函数（如$f(\boldsymbol{X}) = \text{Tr}(\boldsymbol{A}\boldsymbol{X}\boldsymbol{B})$，$\boldsymbol{A},\boldsymbol{B}$为常数矩阵），其矩阵导数可通过“迹的微分性质”推导：$\text{d}f = \text{Tr}\left( (\nabla_{\boldsymbol{X}} f)^\top \cdot \text{d}\boldsymbol{X} \right)$，其中$\text{d}\boldsymbol{X}$是输入矩阵的微小扰动矩阵——该关系将标量微分与矩阵导数直接关联，是推导复杂矩阵函数导数的核心工具。  
- **对称矩阵的导数简化**：若输入矩阵$\boldsymbol{X}$为对称矩阵（$X_{kl}=X_{lk}$），则偏导满足$\frac{\partial f}{\partial X_{kl}} = \frac{\partial f}{\partial X_{lk}}$，因此矩阵导数$\nabla_{\boldsymbol{X}} f$也为对称矩阵，可利用对称性减少计算量（只需计算上三角或下三角元素）。


### 2.2 输出为矩阵（映射：$\mathbb{R}^{p \times q} \to \mathbb{R}^{s \times t}$）：求四维导数张量$T_F$
#### 映射类型定义
函数$F: \mathbb{R}^{p \times q} \to \mathbb{R}^{s \times t}$，输入为$p \times q$矩阵$\boldsymbol{X}$，输出为$s \times t$矩阵$F(\boldsymbol{X}) = [F_{ab}(\boldsymbol{X})]_{s \times t}$（如矩阵的幂、矩阵函数变换），核心是“$p \times q$个输入元素决定$s \times t$个输出元素”。

#### 导数定义与符号
- **导数名称**：四维导数张量（4th-Order Derivative Tensor）  
- **符号**：$T_F(\boldsymbol{X})$ 或 $\frac{\partial F}{\partial \boldsymbol{X}}$  
- **维度**：$s \times t \times p \times q$ 四维张量（输出矩阵维度+输入矩阵维度，对应“输出矩阵元素×输入矩阵元素”的偏导）  
- **数学本质**：矩阵函数$F$的每个输出元素对输入矩阵$\boldsymbol{X}$的所有元素的一阶偏导数构成的高阶有序结构，可理解为“$p \times q$个$s \times t$矩阵切片的集合”（按输入矩阵元素索引）。

#### 普适求导公式
$$T_F(\boldsymbol{X}) = \left[ \frac{\partial F_{ab}}{\partial X_{kl}} \right]_{s \times t \times p \times q}$$  
其“切片表示”更直观：对输入矩阵的每个元素$X_{kl}$（$k=1,2,...,p$；$l=1,2,...,q$），对应张量的第$(k,l)$个“$s \times t$切片”$T_F^{(kl)}(\boldsymbol{X})$，满足：  
$$T_F^{(kl)}(\boldsymbol{X}) = \begin{bmatrix} \frac{\partial F_{11}}{\partial X_{kl}} & \frac{\partial F_{12}}{\partial X_{kl}} & \cdots & \frac{\partial F_{1t}}{\partial X_{kl}} \\ \frac{\partial F_{21}}{\partial X_{kl}} & \frac{\partial F_{22}}{\partial X_{kl}} & \cdots & \frac{\partial F_{2t}}{\partial X_{kl}} \\ \vdots & \vdots & \ddots & \vdots \\ \frac{\partial F_{s1}}{\partial X_{kl}} & \frac{\partial F_{s2}}{\partial X_{kl}} & \cdots & \frac{\partial F_{st}}{\partial X_{kl}} \end{bmatrix}$$  
其中$F_{ab}$表示输出矩阵$F$的第$a$行第$b$列元素（$a=1,2,...,s$；$b=1,2,...,t$）。

#### 非基础名词解释
- **四维张量的索引逻辑**：四维张量$T_F$的索引顺序“$s \times t \times p \times q$”严格对应“输出矩阵行→输出矩阵列→输入矩阵行→输入矩阵列”，确保每个偏导$\frac{\partial F_{ab}}{\partial X_{kl}}$的位置唯一且可追溯——这种索引对齐是后续张量运算（如与输入扰动矩阵的收缩）的基础。  
- **张量的收缩与矩阵扰动**：若输入矩阵有微小扰动$\text{d}\boldsymbol{X}$（$p \times q$矩阵），则输出矩阵的扰动可通过四维张量与$\text{d}\boldsymbol{X}$的收缩运算表示：$\text{d}F_{ab} = \sum_{k=1}^p \sum_{l=1}^q T_F(a,b;k,l) \cdot \text{d}X_{kl}$（对所有输入元素求和），结果与输出矩阵元素$\text{d}F_{ab}$维度一致，体现了导数的“线性近似”本质。


# 二.链式求导与乘积法则
注意一下,如果把n维(约定俗成,其实是1维)列向量看作是 $n \times 1$ 的矩阵,那么这个矩阵的雅可比矩阵就是这个向量的梯度的***转置***!!!

## 一、基础符号定义（映射→导数形态对应表）
| 映射类型（输入→输出）       | 导数符号       | 导数形态（维度） | 核心规则（维度推导）                  |
|------------------------------|----------------|------------------|---------------------------------------|
| $\mathbb{R}^n \to \mathbb{R}$（向量→标量） | $\nabla f$（梯度） | $n \times 1$ 列向量 | 输入$n$个自由度，输出1个，偏导共$n \times 1$个 |
| $\mathbb{R}^n \to \mathbb{R}^m$（向量→向量） | $J_g$（雅可比） | $m \times n$ 矩阵 | 输入$n$个自由度，输出$m$个，偏导共$m \times n$个 |
| $\mathbb{R}^n \to \mathbb{R}^{p \times q}$（向量→矩阵） | $T_A$（张量） | $p \times q \times n$ 三维张量 | 输入$n$个自由度，输出$p \times q$个，偏导共$p \times q \times n$个<br>即n为分量索引,p与q为分量矩阵的行与列 |
| 辅助运算（方阵）             | $\text{Tr}(M)$（迹） |              | 主对角线元素和，用于多维导数降维      |
| 辅助运算（矩阵）             | $M^\top$（转置） |  | 交换行列，用于调整维度适配乘法        |
| 辅助运算（矩阵与张量适配乘法） | $M_{r \times s} \cdot T_{s \times t \times n}=U_{r \times t \times n}$ $T_{s \times t \times n} \cdot M_{t \times r}=U_{s \times r \times n}$ |  | 即将有n个矩阵分量的张量的每一个分量与矩阵相乘,具有严格顺序 |
| 辅助运算（矩阵与张量适配乘法） |  | |  |


## 二、链式法则（复合函数求导）
| 场景（映射链）               | 普适公式                                  | 维度验证（左→右）                     | 关键说明                              |
|------------------------------|-------------------------------------------|---------------------------------------|---------------------------------------|
| 向量→向量→标量<br>$\mathbb{R}^n \xrightarrow{g} \mathbb{R}^m \xrightarrow{f} \mathbb{R}$ | $\nabla (f \circ g)(x) = J_g(x)^\top \cdot \nabla f(g(x))$ | $n \times m \cdot m \times 1 = n \times 1$ | 雅可比转置适配梯度维度，避免乘法矛盾  |
| 向量→向量→向量<br>$\mathbb{R}^n \xrightarrow{g} \mathbb{R}^m \xrightarrow{h} \mathbb{R}^p$ | $J_{h \circ g}(x) = J_h(g(x)) \cdot J_g(x)$ | $p \times m \cdot m \times n = p \times n$ | 雅可比维度天然适配，直接相乘传递影响  |
| 向量→矩阵→标量<br>$\mathbb{R}^n \xrightarrow{A} \mathbb{R}^{p \times q} \xrightarrow{f} \mathbb{R}$ | $\nabla (f \circ A)(x) = \text{Tr}\left( \nabla_A f \otimes T_A(x) \right)$ | $p \times q \otimes p \times q \times n \xrightarrow{\text{Tr}} n \times 1$ | 张量-矩阵适配乘后，用迹降维至梯度    |


## 三、乘积法则（乘积函数求导）
| 场景（乘积映射）             | 普适公式                                  | 维度验证（两项均需一致）              | 关键说明                              |
|------------------------------|-------------------------------------------|---------------------------------------|---------------------------------------|
| 向量点积<br>$f=u \cdot v: \mathbb{R}^n \to \mathbb{R}$（$u,v:\mathbb{R}^n \to \mathbb{R}^m$） | $\nabla f(x) = J_u^\top \cdot v + J_v^\top \cdot u$ | 两项均为 $n \times m \cdot m \times 1 = n \times 1$ | 转置雅可比，使向量乘结果适配梯度维度  |
| 矩阵乘法<br>$f=A \cdot B: \mathbb{R}^n \to \mathbb{R}^{p \times r}$（$A:\mathbb{R}^n \to \mathbb{R}^{p \times q}, B:\mathbb{R}^n \to \mathbb{R}^{q \times r}$） | $T_f(x) = T_A \cdot B + A \cdot T_B$ | 两项均为 $p \times q \times n \cdot q \times r = p \times r \times n$ | 张量切片与矩阵乘，确保结果为矩阵输出对应的张量 |
| 标量-向量乘积<br>$f=s \cdot v: \mathbb{R}^n \to \mathbb{R}^m$（$s:\mathbb{R}^n \to \mathbb{R}, v:\mathbb{R}^n \to \mathbb{R}^m$） | $J_f(x) = s \cdot J_v + v \cdot \nabla s^\top$ | 两项均为 $m \times n$（标量乘矩阵/向量外积） | 梯度转置后与向量外积，适配雅可比维度  |
| 标量-矩阵乘积<br>$f=s \cdot A: \mathbb{R}^n \to \mathbb{R}^{p \times q}$（$s:\mathbb{R}^n \to \mathbb{R}, A:\mathbb{R}^n \to \mathbb{R}^{p \times q}$） | $T_f(x) = s \cdot T_A + A \cdot (\nabla s \otimes I_{p \times q})$ | 两项均为 $p \times q \times n$（标量乘张量/矩阵-扩展张量乘） | 梯度与单位矩阵张量积，扩展为矩阵输出对应的张量 |


## 四、核心通用规则（所有场景适用）
1. **映射定形态**：输入→输出的维度链，唯一决定导数用梯度（标量输出）、雅可比（向量输出）还是张量（矩阵输出）。  
2. **维度定运算**：矩阵乘需满足“前列=后行”，不满足则转置；张量运算需确保切片维度与矩阵匹配，不满足则扩展。  
3. **法则本质不变**：链式法则是“各层导数复合”，乘积法则是“逐项求导+叠加”，仅导数形态随映射类型调整。